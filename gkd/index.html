<!DOCTYPE html>
    <!--
    _____                   _      
  / ____|                 | |     
 | |  __  ___   ___   __ _| | ___ 
 | | |_ |/ _ \ / _ \ / _` | |/ _ \
 | |__| | (_) | (_) | (_| | |  __/
  \_____|\___/ \___/ \__, |_|\___|
                      __/ |       
                谷歌 |___/        

    Google Present, 2020
    -->

    <head>
        <meta charset="utf-8" />
        <title>图片</title>

        <link href="https://cdn.muicss.com/mui-0.10.3/css/mui.min.css" rel="stylesheet" type="text/css" />
        <script src="https://cdn.muicss.com/mui-0.10.3/js/mui.min.js"></script>
        <script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
        <script src="jquery.animate-shadow-min.js"></script>
  
        <style>
             .childcenter{
                position: fixed;
                width: 200px;
                height: 150px;
                top:50%;
                left: 50%;
                margin-top: -75px;
                margin-left:-100px ;

                text-align: center;
            }

            .bar{
                width: 500px;
                height: 50px;
                box-shadow: 0px 0px 0px;
                text-align: center;
                position: fixed;

                margin-top: 20px;
                margin-left: -150px;

                border-radius:25px;
                border: 1px solid #dddddd;

            }

            .textinput{
                border: 0px;
                border-bottom: 1px solid #aaaaaa;
            }

            a{color:#5f6368; cursor:pointer}
            a:link{color:#5f6368;}
            a:visited{color:#5f6368;}
            a:hover{color:#5f6368; text-decoration:underline}
            a:active{color:#FF0000; text-decoration:underline}
        </style>

        <script>

            function myRandom(seed, min, max){
                seed = (seed * 9301 + 49297) % 233280;

                return parseInt((seed / 233280.0 * 10000000) % (max - min + 1) + min);
            }

            function Generate(){
                for (var i=50;i>=1;i--)
                { 
                    document.getElementById("debug").innerHTML += (myRandom(document.getElementById('key').value, 1, i) + "<br />");
                }
            }

            function Test3(){
                document.getElementById("debug").innerHTML += (myRandom(document.getElementById('key').value, 1, 2) + "<br />");
                document.getElementById("debug").innerHTML += (myRandom(document.getElementById('key').value, 1, 100) + "<br />");
                document.getElementById("debug").innerHTML += (myRandom(document.getElementById('key').value, 1, 100) + "<br />");
                document.getElementById("debug").innerHTML += (myRandom(document.getElementById('key').value, 1, 2) + "<br />");
            }

            //把图画上canvas的函数
            function DrawOnCanvas(){

                //document.getElementById("tulip").src = window.URL.createObjectURL(document.getElementById("laFile").files[0]);

                var c=document.getElementById("myCanvas");
                var ctx=c.getContext("2d");
                var img=document.getElementById("tulip");

                c.style="Width: " + img.naturalWidth + "px; Height: " + img.naturalHeight + "px"; 
                c.width = img.naturalWidth;
                c.height = img.naturalHeight;
                ctx.clearRect(0,0,c.width,c.height);  
                ctx.drawImage(img, 0, 0, c.width, c.height);
            }

            /* 这个函数在手机端有bug
            function Download(srlink){
                var link = document.createElement('a');
                //设置下载的文件名
                var myDate = new Date();
                link.download = "Image" + myDate.toLocaleString( ) + ".png";
                link.style.display = 'none';
                //设置下载路径
                link.href = srlink;
                //触发点击
                document.body.appendChild(link);
                link.click();
                //移除节点
                document.body.removeChild(link);
            }
            */

            function DownloadPNG(){
                var myDate = new Date();
                download(document.getElementById('myCanvas').toDataURL('image/png'), "Image" + myDate.toLocaleString( ) + ".png");
            }

            //交换第 A 行与第 B 行，从第 1 行开始，行高为 deltah
            function SwapCanvasLines(A, B, deltah){
                var c=document.getElementById("myCanvas");
                var ctx=c.getContext("2d");

                var dataA = ctx.getImageData(0, A - 1, c.clientWidth - 1, deltah);
                var dataB = ctx.getImageData(0, B - 1, c.clientWidth - 1, deltah);

                ctx.putImageData(dataB, 0, A - 1);
                ctx.putImageData(dataA, 0, B - 1);
            }

            function Enc(){
                var c=document.getElementById("myCanvas");
                var dh = document.getElementById("deltah").value;

                for(var j = 0; j < document.getElementById("count").value; j++){
                    for (var i=parseInt((c.clientHeight-dh+1)/dh);i>=1;i--)
                    { 
                        SwapCanvasLines(myRandom(document.getElementById('key').value, 1, i)*dh, i*dh, dh);
                    }
                }
            }

            function Dec(){
                var c = document.getElementById("myCanvas");
                var dh = document.getElementById("deltah").value;

                for(var j = 0; j < document.getElementById("count").value; j++){
                    for (var i=1;i<=parseInt((c.clientHeight-dh+1)/dh);i++)
                    { 
                        SwapCanvasLines(myRandom(document.getElementById('key').value, 1, i)*dh, i*dh, dh);
                    }
                }
            }

        </script>
        <script src="download.js"></script>

    </head>

    <body>

        <div class="childcenter">
            <img src="picenc.png" width="272px" height="101px" style="margin-left: -35px; margin-top: -90px" />
            <div class="bar">
                <div style="margin-top:12px">
                    <input id="pasteimage" class="textinput" type=text placeholder="在这里粘贴图片"></input>
                    &nbsp;或&nbsp;
                    <input id="laFile" type="file" accept="image/*" onchange='document.getElementById("tulip").src = window.URL.createObjectURL(document.getElementById("laFile").files[0]);document.getElementById("drawbutton").disabled="";'></input>
    
                </div>
            </div>

            <button id="drawbutton" class="mui-btn mui-btn--raised" onclick="DrawOnCanvas(); $('.back').css({'height':'100vh','width':'100vw', 'overflow':'visible'})" style="background-color: #f4f4f4; color:#5f6368; font-size: 16px; margin-top: 100px" disabled>开始</button>
        </div>

        <image id="tulip" src="" style="display:none"></image>

        <div class="back" style="width:0;height:0;z-index:100;position:absolute">
            <div class="back" style="background-color: white; width: 0; height: 0; overflow:hidden; position:absolute">
                <div style="width: 100vw; height: 35px; background-color: #f2f2f2; border-bottom: 1px solid #e4e4e4; position:fixed">
                    <a onclick="location.reload()" style="margin:20px; margin-top:8px; position:absolute; font-size: 14px; float:left">主界面</a>
                    <p style="margin-right: 20px; margin-top: 8px; text-align:right; float:right">Google Present, 2020</p>
                </div>

                <div style="margin: 40px">
                    <canvas id="myCanvas" style=" position:relative"></canvas>

                    <div style="margin-left: 200px">
                        <br />
                        <span>参数：</span>
                        <input id="key" class="textinput" type=text placeholder="输入种子" style="width:70px;margin:10px;margin-top:20px" value="74751"></input>
                        <input id="count" class="textinput" type=text placeholder="加密次数" style="width:70px;margin:10px;margin-top:20px" value="5"></input>
                        <input id="deltah" class="textinput" type=text placeholder="行交换高度" style="width:70px;margin:10px;margin-top:20px" value="3"></input> 
                        
                        <br />
                        <button class="mui-btn mui-btn" type=button onclick="Enc()">加密</button>
                        <button class="mui-btn mui-btn" type=button onclick="Dec()">解密</button>
                        <button class="mui-btn mui-btn" type=button onclick="DownloadPNG();">将结果存为PNG</button>
                    </div>

                </div>
            </div>
        </div>
    

        <!--用于调取剪贴板的script，由于要等待dom加载所以放在最末-->
        <script>
            var inputt = document.getElementById("pasteimage");
                    
            inputt.addEventListener( 'paste', function( event ){
                var clipboardData = event.clipboardData, i = 0, items, item, types;
            
                if( clipboardData ){
                    items = clipboardData.items;
                
                    if( !items ){
                        return;
                    }
                
                    item = items[0];
                    // 保存在剪贴板中的数据类型
                    types = clipboardData.types || [];
                
                    for( ; i < types.length; i++ ){
                        if( types[i] === 'Files' ){
                            item = items[i];
                            break;
                        }
                    }
                
                    // 判断是否为图片数据
                    if( item && item.kind === 'file' && item.type.match(/^image\//i) ){
                        // 读取该图片           
                        imgReader( item );
                    }
                }
            })
            var imgReader = function( item ){
            var file = item.getAsFile(),
                reader = new FileReader()
                // 读取文件后将其显示在网页中
                reader.onload = function( e ){
                    document.getElementById("tulip").src = e.target.result;
                };
            // 读取文件
            reader.readAsDataURL( file );

            document.getElementById("drawbutton").disabled = "";

            document.getElementById("pasteimage").placeholder = "OK!";
            };
        </script>

        <!--在控制台里打 Google 的 script-->
        <script>
            console.log(
                "    _____                   _      \n\
  / ____|                 | |     \n\
 | |  __  ___   ___   __ _| | ___ \n\
 | | |_ |/ _ \\ / _ \\ / _` | |/ _ \\\n\
 | |__| | (_) | (_) | (_| | |  __/\n\
  \\_____|\\___/ \\___/ \\__, |_|\\___|\n\
                      __/ |       \n\
                谷歌 |___/        \n\
\n\
    Google Present, 2020"
            );
        </script>
        
        <!-- Jquery -->
        <script>
            $(document).ready(function(){
                $(".bar").mouseleave(function(){
                    $(".bar").animate({'box-shadow': '0px 0px 0px '}, 50 );
                });
                $(".bar").mouseenter(function(){
                    $(".bar").animate({'box-shadow': '0px 2px 4px #aaaaaa' }, 50);
                });
            });
        </script>
    </body>
</html>